<html lang="it">
<head>
<meta charset="UTF-8">
<title>Scanner Magazzino</title>
<style>
    body { font-family: Arial; padding: 20px; text-align: center; }
    #preview { width: 90%; border: 2px solid black; margin-bottom: 20px; }
    button { padding: 15px; font-size: 20px; margin: 10px; width: 40%; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
</head>
<body>

<h2>ðŸ“¦ Scanner Magazzino</h2>

<!-- ANTEPRIMA VIDEO CORRETTA -->
<video id="preview" autoplay playsinline></video>

<h3 id="code">CODICE: â€”</h3>

<button onclick="sendData('carico')" style="background:#4CAF50;color:white;">CARICO</button>
<button onclick="sendData('scarico')" style="background:#D32F2F;color:white;">SCARICO</button>

<script>

// ðŸ”¥ START FOTOCAMERA (compatibile con tutti i telefoni)
async function startCamera() {
    const video = document.getElementById("preview");

    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: { ideal: "environment" },   // camera posteriore
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        });

        video.srcObject = stream;

        startQuagga();

    } catch (err) {
        alert("Errore accesso fotocamera: " + err);
        console.error(err);
    }
}

// ðŸ”¥ QUAGGA INIT (usa il video giÃ  avviato)
function startQuagga() {
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#preview'),
        },
        decoder: {
            readers: ["ean_reader", "ean_13_reader", "code_128_reader"]
        }
    }, function(err) {
        if (err) { console.error(err); return; }
        Quagga.start();
    });

    let lastCode = "";

    Quagga.onDetected(function(result) {
        const code = result.codeResult.code;

        if (code !== lastCode) {
            lastCode = code;
            window.lastDetected = code;  // globale
            document.getElementById("code").innerText = "CODICE: " + code;
        }
    });
}

// âœ” CARICA/SCARICA SU GOOGLE SHEETS
function sendData(type) {

    if (!window.lastDetected) {
        alert("Scansiona prima un codice!");
        return;
    }

    fetch("https://script.google.com/macros/s/AKfycbww7kWmX-qDmG5an3JtEDEo8P-gqB3icmoQkyatWLx5JWgiV3VWGMFf-c7qZS1MNkoH/exec", {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            barcode: window.lastDetected,
            operazione: type
        })
    });

    alert("Operazione inviata!");
}

// Avvia fotocamera al caricamento
startCamera();

</script>

</body>
</html>
